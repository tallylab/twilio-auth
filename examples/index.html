<!doctype html>
<html>
  <head>
    <title>Twilio Auth Example</title>

    <style>
      label { display: block; }
      #step2, #step3a, #step3b { display: none; }
    </style>

    <script>
      const worker = new Worker('./worker/worker/worker.js')

      // A simple catchall to transliterate worker messages to document events, should make it easy
      worker.onmessage = (event) => {
        const message = event.data
        document.dispatchEvent(new CustomEvent(message.type, { detail: message.payload }));
      }
    </script>
  </head>
  <body>
    <h1>Twilio Auth Examples</h1>

    <script>
      const headers = {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }

      window.submitVerification = function(form) {
        const to = form.elements[0].value

        fetch("http://127.0.0.1:3000/verify", {
          headers,
          method: 'POST',
          body: JSON.stringify({ to })
        })
          .then((res) => {
            // TODO: Proper error handling
            if (res.status !== 200) return;

            // TODO: Keep phone number in field
            document.querySelector('#step1').style.display = 'none';
            document.querySelector('#step2').style.display = 'block';
            document.querySelector('#step2').elements[0].value = to;
          })

        return false;
      }

      window.submitCode = function(form) {
        const to = form.elements[0].value
        const code = form.elements[1].value

        fetch("http://127.0.0.1:3000/login", {
          headers,
          method: 'POST',
          body: JSON.stringify({ to, code })
        })
          .then(async (res) => {
            // TODO: Proper error handling
            if (res.status !== 200) return;

            const rawKeys = await res.json()
            const uintify = (string) => Uint8Array.from(string.split(','))
            worker.postMessage({
              type: 'identity-v1',
              payload: {
                signing: {
                  signPk: uintify(rawKeys.signing.signPk),
                  signSk: uintify(rawKeys.signing.signSk),
                },
                publicKey: uintify(rawKeys.publicKey),
                privateKey: uintify(rawKeys.privateKey),
                securityVersion: rawKeys.securityVersion
              }
            })
          })

        return false;
      }

      document.addEventListener('identity-v1-success', (e) => {
        document.querySelector('#step2').style.display = 'none';

        if(e.detail.lastEntry.length === 0) {
          document.querySelector('#step3a').style.display = 'block';

          localStorage.setItem('key1', Math.random() * 1000)
          localStorage.setItem('key2', Math.random() * 1000)
          localStorage.setItem('key3', Math.random() * 1000)

          worker.postMessage({
            type: 'snapshot-v1',
            payload: {
              key1: localStorage.getItem('key1'),
              key2: localStorage.getItem('key2'),
              key3: localStorage.getItem('key3')
            }
          })
        } else {
          document.querySelector('#step3b').style.display = 'block';
          document.querySelector('#foundData').innerHTML =
            JSON.stringify(e.detail.lastEntry[0].payload.value)
        }
      })

      document.addEventListener('snapshot-v1-success', (e) => {
        console.log(e.detail)
      })
    </script>

    <form id="step1" onsubmit="return submitVerification(this)">
      <label>Input number for verification
        <input type="tel" value="" />
      </label>

      <input type="submit" value="Submit" />
    </form>

    <form id="step2" onsubmit="return submitCode(this)">
      <label>Input number for verification
        <input type="tel" value="" />
      </label>

      <label>Enter code
        <input type="number" value="" />
      </label>

      <input type="submit" value="Submit" />
    </form>

    <div id="step3a">
      No data found! Writing some random data to localStorage
      and sending the snapshot to OrbitDB.
    </div>

    <div id="step3b">
      Found data. The last snapshot of the DB was:
      <pre id="foundData"></pre>
    </div>
  </body>
</html>
